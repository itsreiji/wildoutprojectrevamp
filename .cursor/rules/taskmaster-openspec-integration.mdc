---
description: Enforce openspec proposal creation for every task-master task to ensure documentation and architectural alignment
globs: .taskmaster/tasks/**/*.md, .taskmaster/tasks/tasks.json
alwaysApply: true
---

# Task-Master & OpenSpec Integration Rule

## Core Requirement

**STRICT ENFORCEMENT**: Every task created in task-master **MUST** include a corresponding openspec proposal before implementation begins.

## Workflow Integration

### When Creating Tasks

1. **Parse PRD (`parse_prd`)**:
   - After generating tasks from PRD
   - Immediately create openspec proposals for each generated task
   - Link proposal IDs in task details

2. **Add Individual Task (`add_task`)**:
   - Before marking task as ready to implement
   - Create openspec proposal with task context
   - Reference proposal in task `details` field

3. **Expand Task (`expand_task`)**:
   - When breaking down complex tasks into subtasks
   - Create or update the parent task's openspec proposal
   - Include subtask breakdown in proposal's implementation plan

### Subtask Handling

**Default Approach**: Subtasks are **covered within the parent task's proposal** as part of the implementation checklist. The parent task's proposal should include:
- **Implementation checklist** derived from all subtasks (in `tasks.md`)
- **Subtask breakdown** in the technical specifications
- **Dependencies** between subtasks documented in the proposal

**When Subtasks Need Separate Proposals**:
A subtask should have its **own proposal** if it meets any of these criteria:
- **Architectural significance**: Introduces new patterns, frameworks, or architectural decisions
- **Breaking changes**: Modifies APIs, schemas, or contracts that affect other systems
- **Independent scope**: Can be implemented and deployed independently from parent task
- **Complexity threshold**: Requires detailed design decisions, trade-offs, or research beyond what fits in parent proposal
- **Cross-cutting concerns**: Affects multiple capabilities or systems beyond the parent task's scope

**Subtask Proposal Workflow**:
1. When a subtask requires its own proposal:
   - Create proposal with ID: `YYYYMMDD-parent-task-id-subtask-id-description`
   - Link the subtask proposal in the subtask's `details` field
   - Reference the parent task proposal in the subtask proposal metadata
   - Update parent task proposal to reference the subtask proposal
2. Subtask proposals follow the same format and requirements as parent task proposals
3. Subtask proposal status should sync with subtask status (see Status Synchronization)

**Example Structure**:
```
Parent Task (ID: 5) → Proposal: `20250115-user-authentication`
├── Subtask 5.1 → Covered in parent proposal's tasks.md
├── Subtask 5.2 → Covered in parent proposal's tasks.md
└── Subtask 5.3 (Complex: New auth framework) → Separate proposal: `20250115-user-auth-5-3-oauth-integration`
```

### Task Details Format

Every task's `details` field must include:

```markdown
## OpenSpec Proposal
- **Proposal ID**: `YYYYMMDD-descriptive-name`
- **Status**: [draft|review|approved|implemented]
- **Location**: `openspec/proposals/YYYYMMDD-descriptive-name.md`

## Implementation Details
[Rest of task details...]
```

### Openspec Proposal Requirements

Each proposal created for a task must include:

- **Clear problem statement** aligned with task description
- **Proposed solution** matching task implementation approach
- **Technical specifications** detailing the work required
- **Dependencies** mirroring task dependencies
- **Testing strategy** from task's `testStrategy` field
- **Implementation checklist** derived from subtasks (if any)

## Agent Behavior

### ✅ DO

- **Create proposals immediately** after task generation
- **Update proposals** when tasks are modified via `update_task` or `update_subtask`
- **Reference task IDs** in proposal metadata for bidirectional linking
- **Use task priority** to determine proposal urgency
- **Sync status changes** between tasks and proposals
- **Include research findings** from `research` tool in proposals

### ❌ DON'T

- **Never skip** proposal creation - this is mandatory
- **Don't implement** tasks without approved proposals
- **Don't create orphaned** tasks without proposals
- **Don't modify** task structure without updating proposals

## Command Sequence Examples

### Example 1: Generating Tasks from PRD

```bash
# Step 1: Parse PRD
task-master parse-prd requirements.txt

# Step 2: Agent automatically creates proposals
# For each task T:
#   1. Create openspec/proposals/YYYYMMDD-task-T.md
#   2. Update task T details with proposal reference
#   3. Generate proposal following openspec guidelines

# Step 3: Review proposals before implementation
```

### Example 2: Adding Individual Task

```bash
# Step 1: Add task (agent process)
task-master add-task --prompt "Implement JWT authentication" --priority high

# Step 2: Agent immediately creates proposal
# - Extract task context
# - Generate openspec/proposals/YYYYMMDD-jwt-auth.md
# - Link proposal in task details
# - Set proposal status to 'draft'

# Step 3: Review and approve proposal
# Step 4: Mark task as ready (status: pending)
```

### Example 3: Expanding Complex Task

```bash
# Step 1: Expand task
task-master expand --id=5 --research

# Step 2: Agent updates/creates proposal
# - Update existing proposal with subtask breakdown
# - Add implementation checklist from subtasks
# - Identify if any subtask needs separate proposal
# - Include research findings in technical specs

# Step 3: Review updated proposal
```

### Example 4: Subtask Requiring Separate Proposal

```bash
# Step 1: Expand task creates subtasks
task-master expand --id=5 --research

# Step 2: Agent identifies complex subtask (e.g., 5.3 introduces new auth framework)
# - Create separate proposal: openspec/changes/20250115-user-auth-5-3-oauth-integration/
# - Link subtask proposal in subtask 5.3 details
# - Reference parent proposal in subtask proposal metadata
# - Update parent proposal to reference subtask proposal

# Step 3: Review both proposals
# - Parent proposal covers overall authentication system
# - Subtask proposal covers OAuth integration specifics
```

## Status Synchronization

| Task Status | Proposal Status | Action Required |
|-------------|----------------|-----------------|
| `pending` | `draft` | Review and approve proposal |
| `in-progress` | `approved` | Implementation in progress |
| `done` | `implemented` | Verify and close proposal |
| `blocked` | `review` | Resolve blockers in proposal |
| `deferred` | `draft` | Document reason in proposal |

**For Subtasks**:
- Subtask status should sync with its proposal status (if separate proposal exists)
- If subtask is covered in parent proposal, track completion in parent proposal's `tasks.md` checklist
- When all subtasks are complete, parent task proposal can move to `implemented` status

## Validation Checklist

Before marking any task as `in-progress`, verify:

- [ ] Openspec proposal exists
- [ ] Proposal ID referenced in task details
- [ ] Proposal status is `approved` or higher
- [ ] Proposal aligns with task requirements
- [ ] All dependencies documented in both task and proposal
- [ ] Test strategy matches between task and proposal

**For Tasks with Subtasks**:
- [ ] All subtasks are included in parent task proposal's `tasks.md` checklist
- [ ] Complex subtasks (if any) have their own proposals with proper linking
- [ ] Subtask dependencies are documented in the proposal
- [ ] Implementation order is clear in the proposal's checklist

**For Subtasks**:
- [ ] Subtask is covered in parent task proposal's implementation checklist, OR
- [ ] Subtask has its own proposal (if it meets complexity criteria) with proper linking to parent
- [ ] Subtask proposal status syncs with subtask status

## Integration Points

### Task-Master Commands That Trigger Proposal Actions

| Command | Proposal Action |
|---------|----------------|
| `parse_prd` | Create proposals for all generated tasks |
| `add_task` | Create proposal for new task |
| `expand_task` | Update parent task proposal with subtask breakdown; create separate proposals for complex subtasks if needed |
| `add_subtask` | Update parent task proposal's implementation checklist; create separate proposal if subtask meets complexity criteria |
| `update_task` | Update proposal with changes |
| `update_subtask` | Append findings to parent task proposal (or subtask proposal if separate) |
| `set_task_status` | Sync proposal status (parent or subtask proposal as applicable) |
| `research` | Include findings in relevant proposal(s) |

### Openspec Commands Integration

- Use `@/openspec/AGENTS.md` for proposal format guidelines
- Follow openspec conventions for change types
- Link proposals to architectural decisions
- Update specs when proposals are approved

## File Organization

```
project-root/
├── .taskmaster/
│   ├── tasks/
│   │   ├── tasks.json (contains proposal references)
│   │   └── task-*.md (individual task files with proposal links)
│   └── docs/
│       └── research/ (research linked to proposals)
└── openspec/
    └── proposals/
        └── YYYYMMDD-*.md (proposals for each task)
```

## Error Prevention

**Common Mistakes to Avoid:**

1. **Creating tasks without proposals**: Agent must auto-create proposals
2. **Implementing before approval**: Check proposal status first
3. **Losing sync**: Update proposals when tasks change
4. **Missing context**: Include all task details in proposals

## Benefits of This Integration

- **Complete Documentation**: Every change is documented before implementation
- **Architectural Alignment**: Proposals ensure changes fit overall design
- **Review Process**: Proposals provide clear review points
- **Knowledge Capture**: Research and decisions documented in proposals
- **Traceability**: Bidirectional links between tasks and proposals

## Reference Documentation

- Task-Master Workflow: [dev_workflow.mdc](mdc:.cursor/rules/taskmaster/dev_workflow.mdc)
- Task-Master Commands: [taskmaster.mdc](mdc:.cursor/rules/taskmaster/taskmaster.mdc)
- OpenSpec Guidelines: [openspec/AGENTS.md](mdc:openspec/AGENTS.md)

---

**Remember**: This integration is **mandatory**. No task should proceed to implementation without its corresponding openspec proposal. This ensures quality, documentation, and architectural consistency across the entire project.
