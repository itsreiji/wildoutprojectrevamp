---
description: Enforce openspec proposal creation for every task-master task to ensure documentation and architectural alignment
globs: .taskmaster/tasks/**/*.md, .taskmaster/tasks/tasks.json
alwaysApply: true
---

# Task-Master & OpenSpec Integration Rule

## Core Requirement

**STRICT ENFORCEMENT**: Every task created in task-master **MUST** include a corresponding openspec proposal before implementation begins.

## Workflow Integration

### When Creating Tasks

1. **Parse PRD (`parse_prd`)**:
   - After generating tasks from PRD
   - Immediately create openspec proposals for each generated task
   - Link proposal IDs in task details

2. **Add Individual Task (`add_task`)**:
   - Before marking task as ready to implement
   - Create openspec proposal with task context
   - Reference proposal in task `details` field

3. **Expand Task (`expand_task`)**:
   - When breaking down complex tasks into subtasks
   - Create or update the parent task's openspec proposal
   - Include subtask breakdown in proposal's implementation plan

### Task Details Format

Every task's `details` field must include:

```markdown
## OpenSpec Proposal
- **Proposal ID**: `YYYYMMDD-descriptive-name`
- **Status**: [draft|review|approved|implemented]
- **Location**: `openspec/proposals/YYYYMMDD-descriptive-name.md`

## Implementation Details
[Rest of task details...]
```

### Openspec Proposal Requirements

Each proposal created for a task must include:

- **Clear problem statement** aligned with task description
- **Proposed solution** matching task implementation approach
- **Technical specifications** detailing the work required
- **Dependencies** mirroring task dependencies
- **Testing strategy** from task's `testStrategy` field
- **Implementation checklist** derived from subtasks (if any)

## Agent Behavior

### ✅ DO

- **Create proposals immediately** after task generation
- **Update proposals** when tasks are modified via `update_task` or `update_subtask`
- **Reference task IDs** in proposal metadata for bidirectional linking
- **Use task priority** to determine proposal urgency
- **Sync status changes** between tasks and proposals
- **Include research findings** from `research` tool in proposals

### ❌ DON'T

- **Never skip** proposal creation - this is mandatory
- **Don't implement** tasks without approved proposals
- **Don't create orphaned** tasks without proposals
- **Don't modify** task structure without updating proposals

## Command Sequence Examples

### Example 1: Generating Tasks from PRD

```bash
# Step 1: Parse PRD
task-master parse-prd requirements.txt

# Step 2: Agent automatically creates proposals
# For each task T:
#   1. Create openspec/proposals/YYYYMMDD-task-T.md
#   2. Update task T details with proposal reference
#   3. Generate proposal following openspec guidelines

# Step 3: Review proposals before implementation
```

### Example 2: Adding Individual Task

```bash
# Step 1: Add task (agent process)
task-master add-task --prompt "Implement JWT authentication" --priority high

# Step 2: Agent immediately creates proposal
# - Extract task context
# - Generate openspec/proposals/YYYYMMDD-jwt-auth.md
# - Link proposal in task details
# - Set proposal status to 'draft'

# Step 3: Review and approve proposal
# Step 4: Mark task as ready (status: pending)
```

### Example 3: Expanding Complex Task

```bash
# Step 1: Expand task
task-master expand --id=5 --research

# Step 2: Agent updates/creates proposal
# - Update existing proposal with subtask breakdown
# - Add implementation checklist from subtasks
# - Include research findings in technical specs

# Step 3: Review updated proposal
```

## Status Synchronization

| Task Status | Proposal Status | Action Required |
|-------------|----------------|-----------------|
| `pending` | `draft` | Review and approve proposal |
| `in-progress` | `approved` | Implementation in progress |
| `done` | `implemented` | Verify and close proposal |
| `blocked` | `review` | Resolve blockers in proposal |
| `deferred` | `draft` | Document reason in proposal |

## Validation Checklist

Before marking any task as `in-progress`, verify:

- [ ] Openspec proposal exists
- [ ] Proposal ID referenced in task details
- [ ] Proposal status is `approved` or higher
- [ ] Proposal aligns with task requirements
- [ ] All dependencies documented in both task and proposal
- [ ] Test strategy matches between task and proposal

## Integration Points

### Task-Master Commands That Trigger Proposal Actions

| Command | Proposal Action |
|---------|----------------|
| `parse_prd` | Create proposals for all generated tasks |
| `add_task` | Create proposal for new task |
| `expand_task` | Update proposal with subtask details |
| `update_task` | Update proposal with changes |
| `update_subtask` | Append findings to proposal |
| `set_task_status` | Sync proposal status |
| `research` | Include findings in proposal |

### Openspec Commands Integration

- Use `@/openspec/AGENTS.md` for proposal format guidelines
- Follow openspec conventions for change types
- Link proposals to architectural decisions
- Update specs when proposals are approved

## File Organization

```
project-root/
├── .taskmaster/
│   ├── tasks/
│   │   ├── tasks.json (contains proposal references)
│   │   └── task-*.md (individual task files with proposal links)
│   └── docs/
│       └── research/ (research linked to proposals)
└── openspec/
    └── proposals/
        └── YYYYMMDD-*.md (proposals for each task)
```

## Error Prevention

**Common Mistakes to Avoid:**

1. **Creating tasks without proposals**: Agent must auto-create proposals
2. **Implementing before approval**: Check proposal status first
3. **Losing sync**: Update proposals when tasks change
4. **Missing context**: Include all task details in proposals

## Benefits of This Integration

- **Complete Documentation**: Every change is documented before implementation
- **Architectural Alignment**: Proposals ensure changes fit overall design
- **Review Process**: Proposals provide clear review points
- **Knowledge Capture**: Research and decisions documented in proposals
- **Traceability**: Bidirectional links between tasks and proposals

## Reference Documentation

- Task-Master Workflow: [dev_workflow.mdc](mdc:.cursor/rules/taskmaster/dev_workflow.mdc)
- Task-Master Commands: [taskmaster.mdc](mdc:.cursor/rules/taskmaster/taskmaster.mdc)
- OpenSpec Guidelines: [openspec/AGENTS.md](mdc:openspec/AGENTS.md)

---

**Remember**: This integration is **mandatory**. No task should proceed to implementation without its corresponding openspec proposal. This ensures quality, documentation, and architectural consistency across the entire project.
